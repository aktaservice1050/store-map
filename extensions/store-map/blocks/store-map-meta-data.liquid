{% comment %}
  Store Locator with Flexible Page Metafield Support
  File: blocks/store-locator.liquid
{% endcomment %}

{% assign unique_id = block.id | replace: '-', '_' %}

{{ 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css' | stylesheet_tag }}

<style>
  .store-locator {
    max-width: 1440px;
    margin: 0 auto;
    padding: 20px 0;
  }

  .store-locator__grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
  }

  .store-locator__map {
    height: 600px;
    border-radius: 10px;
  }

  .store-locator__sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
    border-radius: 8px;
  }

  .store-locator__search {
    background: white;
    border-radius: 10px;
  }

  .store-locator__search h3 {
    margin: 0 0 15px 0;
    font-size: 32px;
    font-weight: 700;
    text-transform: uppercase;
    color: #5568d3;
  }

  .store-locator__search p {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #5568d3;
  }

  .store-locator__input-group {
    display: flex;
    gap: 10px;
    border-radius: 50px;
    font-size: 16px;
    background: #E6EFFA;
    padding: 4px;
  }

  .store-locator__input {
    flex: 1;
    padding: 12px 15px;
    border: none;
    border-radius: 50px;
    font-size: 16px;
    background: transparent;
  }

  .store-locator__input:focus {
    outline: none;
  }

  .store-locator__button {
    padding: 12px 25px;
    background: rgba(239, 197, 71, 1);
    color: #000;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 700;
  }

  .store-locator__button:hover {
    background: #5568d3;
  }

  .store-locator__status {
    margin-top: 10px;
    font-size: 14px;
    color: #666;
  }

  .store-locator__list {
    background: white;
    border-radius: 10px;
    padding-top: 10px;
    max-height: 400px;
    overflow-y: auto;
  }

  .store-locator__item {
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s;
    background: #1E4488;
  }

  .store-locator__item:hover {
    border-color: #667eea;
    transform: translateY(-2px);
  }

  .store-locator__name {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 5px;
    color: #fff;
    font-weight: 700;
    text-transform: uppercase;
  }

  .store-locator__address,
  .store-locator__phone {
    color: #fff;
    font-size: 14px;
    margin-bottom: 5px;
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .store-locator__store-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 10px;
  }

  .leaflet-popup-content {
    margin: 13px 24px 13px 20px;
    line-height: 1.3;
    font-size: 13px;
    min-height: 1px;
  }

  .leaflet-popup-content img {
    width: 100%;
    max-width: 200px;
    border-radius: 4px;
    margin-bottom: 8px;
  }

  @media (max-width: 768px) {
    .store-locator__grid {
      grid-template-columns: 1fr;
    }
    .store-locator__map {
      height: 400px;
    }
  }
</style>

<div class="store-locator" data-store-locator="{{ unique_id }}">
  <div class="store-locator__grid">
    <div id="map_{{ unique_id }}" class="store-locator__map"></div>

    <div class="store-locator__sidebar">
      <div class="store-locator__search">
        <h3>{{ block.settings.heading }}</h3>
        <p>{{ block.settings.subtitle }}</p>
        <div class="store-locator__input-group">
          <input
            type="text"
            id="searchInput_{{ unique_id }}"
            class="store-locator__input"
            placeholder="{{ block.settings.search_placeholder }}"
          />
          <button class="store-locator__button" data-search-btn="{{ unique_id }}">
            {{ block.settings.search_button }}
          </button>
        </div>
        <div id="locationStatus_{{ unique_id }}" class="store-locator__status"></div>
      </div>
      <div id="storeList_{{ unique_id }}" class="store-locator__list"></div>
    </div>
  </div>
</div>

{% comment %} Store data from Page Metafield {% endcomment %}
<script id="storeData_{{ unique_id }}" type="application/json">
[
  {% if shop.metaobjects.store_location.values %}
    {% for store in shop.metaobjects.store_location.values %}
      {
        "id": {{ forloop.index }},
        "name": {{ store.store_name.value | json }},
        "address": {{ store.address.value | json }},
        "lat": {{ store.latitude.value | default: 0 }},
        "lng": {{ store.longitude.value | default: 0 }},
        "phone": {{ store.phone.value | default: "" | json }},
        "email": {{ store.email.value | default: "" | json }},
        "image": {% if store.store_image.value %}{{ store.store_image.value | image_url: width: 300 | json }}{% else %}""{% endif %},
        "hours": {{ store.opening_hours.value | default: "" | json }}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  {% elsif block.settings.stores_json != blank %}
    {% comment %} Use JSON from settings if metafield is empty {% endcomment %}
    {{ block.settings.stores_json }}
  {% else %}
    {% comment %} Default fallback data {% endcomment %}
    {"id":1,"name":"Store One - Dhaka","address":"Gulshan 1, Dhaka","lat":23.7808,"lng":90.4132,"phone":"01711-111111","email":"","image":"","hours":""},
    {"id":2,"name":"Store Two - Banani","address":"Banani, Dhaka","lat":23.7937,"lng":90.4066,"phone":"01722-222222","email":"","image":"","hours":""},
    {"id":3,"name":"Store Three - Mirpur","address":"Mirpur 10, Dhaka","lat":23.8067,"lng":90.3685,"phone":"01733-333333","email":"","image":"","hours":""}
  {% endif %}
]
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script>
(function () {
  'use strict';

  const uniqueId = '{{ unique_id }}';

  if (!window.StoreLocators) {
    window.StoreLocators = {};
  }

  class StoreLocatorInstance {
    constructor(id) {
      this.id = id;
      this.stores = [];
      this.map = null;
      this.markers = [];

      this.loadStores();
      this.initMap();
      this.setupEvents();
    }

    /* ---------- LOAD STORES ---------- */
    loadStores() {
      try {
        const el = document.getElementById('storeData_' + this.id);
        if (el) {
          const raw = JSON.parse(el.textContent.trim());

          this.stores = raw
            .map(s => ({
              ...s,
              lat: Number(s.lat),
              lng: Number(s.lng)
            }))
            .filter(s => !isNaN(s.lat) && !isNaN(s.lng));
        }
      } catch (e) {
        console.error('Store JSON error', e);
      }

      if (!this.stores.length) {
        console.warn('No valid stores found');
      }
    }

    /* ---------- MAP ---------- */
    initMap() {
      const el = document.getElementById('map_' + this.id);
      if (!el) return;

      if (typeof L === 'undefined') {
        setTimeout(() => this.initMap(), 100);
        return;
      }

      this.map = L.map(el).setView([23.8103, 90.4125], 12);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(this.map);

      this.renderStores(this.stores);
    }

    setupEvents() {
      const btn = document.querySelector(`[data-search-btn="${this.id}"]`);
      const input = document.getElementById('searchInput_' + this.id);

      if (btn) btn.addEventListener('click', () => this.search());
      if (input) {
        input.addEventListener('keypress', e => {
          if (e.key === 'Enter') this.search();
        });
      }
    }

    /* ---------- RENDER STORES ---------- */
    renderStores(stores) {
      this.markers.forEach(m => this.map.removeLayer(m));
      this.markers = [];

      stores.forEach(store => {
        const marker = L.marker([store.lat, store.lng])
          .addTo(this.map)
          .bindPopup(`
            ${store.image ? `<img src="${store.image}" style="width:100%;margin-bottom:6px">` : ''}
            <strong>${store.name}</strong><br>
            üìç ${store.address}
          `);

        marker.storeId = store.id;

        this.markers.push(marker);
      });

      if (this.markers.length > 1) {
        const group = L.featureGroup(this.markers);
        this.map.fitBounds(group.getBounds(), { padding: [40, 40] });
      } else if (this.markers.length === 1) {
        this.map.setView(this.markers[0].getLatLng(), 14);
      }

      this.renderList(stores);
    }

    /* ---------- LIST ---------- */
    renderList(stores) {
      const list = document.getElementById('storeList_' + this.id);
      if (!list) return;

      list.innerHTML = stores.map(store => `
        <div class="store-locator__item" data-id="${store.id}">
          <div class="store-locator__name">${store.name}</div>
          <div class="store-locator__address">üìç ${store.address}</div>
        </div>
      `).join('');

      list.querySelectorAll('[data-id]').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.dataset.id;
          this.focusStore(id);
        });
      });
    }

    /* ---------- FOCUS ---------- */
    focusStore(storeId) {
      const marker = this.markers.find(m => m.storeId == storeId);
      if (!marker) return;

      this.map.setView(marker.getLatLng(), 15);
      marker.openPopup();
    }

    /* ---------- SEARCH ---------- */
    search() {
      const input = document.getElementById('searchInput_' + this.id);
      const term = input ? input.value.toLowerCase() : '';

      const filtered = term
        ? this.stores.filter(s =>
            s.name.toLowerCase().includes(term) ||
            s.address.toLowerCase().includes(term)
          )
        : this.stores;

      this.renderStores(filtered);
    }
  }

  function init() {
    window.StoreLocators[uniqueId] = new StoreLocatorInstance(uniqueId);
  }

  document.readyState === 'loading'
    ? document.addEventListener('DOMContentLoaded', init)
    : init();
})();
</script>



{% schema %}
{
  "name": "Store Locator meta",
  "target": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "üí° Add stores via Page Metafield: custom.store_locations (recommended) OR use JSON below as fallback"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Find Epic Bites Near You"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "We proudly partner with top retailers to bring our snacks to you."
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Search Placeholder",
      "default": "Search by name or address..."
    },
    {
      "type": "text",
      "id": "search_button",
      "label": "Search Button",
      "default": "Search"
    },
    {
      "type": "header",
      "content": "Fallback: JSON Data (Optional)"
    },
    {
      "type": "textarea",
      "id": "stores_json",
      "label": "Stores (JSON Array)",
      "info": "Only used if metaobjects empty. Must be valid JSON array. Example: [{\"id\":1,\"name\":\"Store 1\",\"address\":\"Address\",\"lat\":23.78,\"lng\":90.41,\"phone\":\"123\",\"email\":\"\",\"image\":\"\",\"hours\":\"\"},{\"id\":2,\"name\":\"Store 2\",\"address\":\"Address 2\",\"lat\":23.79,\"lng\":90.40,\"phone\":\"456\",\"email\":\"\",\"image\":\"\",\"hours\":\"\"}]"
    }
  ]
}
{% endschema %}
